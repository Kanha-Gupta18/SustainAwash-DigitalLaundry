<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sustainawash</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f6; color: #333; margin: 0; padding: 0;}
        .container { max-width: 600px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);}
        h1, h2 { text-align: center; color: #006a4e; }
        h1 { margin-top: 0; }
        nav { display: flex; justify-content: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 20px;}
        nav button { padding: 12px 20px; font-size: 16px; font-weight: bold; margin: 0 10px; border: 2px solid #006a4e; background-color: #fff; color: #006a4e; border-radius: 8px; cursor: pointer; transition: all 0.2s ease;}
        nav button.active, nav button:hover { background-color: #006a4e; color: #fff;}
        .form-group { margin-bottom: 15px;}
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600;}
        .form-group input { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; font-size: 16px;}
        .btn-submit { width: 100%; padding: 15px; font-size: 18px; font-weight: bold; background-color: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px;}
        .btn-submit:hover { background-color: #0056b3;}
        .page { display: none; }
        .page.active { display: block;}
        #receiptPage { text-align: center;}
        #qrcode { width: 250px; height: 250px; margin: 20px auto; border: 5px solid #eee; border-radius: 10px; padding: 10px;}
        #receiptDetails { background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 8px; padding: 15px; text-align: left;}
        #receiptDetails p, #receiptDetails ul { margin: 8px 0; font-size: 18px;}
        #receiptDetails ul { padding-left: 18px; margin: 6px 0 0 0; }
        #qr-reader { width: 100%; max-width: 500px; margin: 20px auto; border: 2px solid #eee; border-radius: 8px;}
        #scanResult { padding: 15px; border-radius: 8px; margin-top: 20px; font-size: 18px; font-weight: bold; text-align: center;}
        #scanResult.success { background-color: #e6f7ec; border: 1px solid #b7e1cd; color: #1f7a4d;}
        #scanResult.error { background-color: #fdecea; border: 1px solid #f8c0b7; color: #a91e0a;}
        #collectButton { display: none; width: 100%; padding: 15px; font-size: 18px; font-weight: bold; background-color: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 20px;}
        #clothLimitWarning { color: #a91e0a; font-size: 15px; margin-top: 4px; display: none; }
        @media (max-width: 700px) {
            .container { max-width: 96vw; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>â™» Sustainawash</h1>
        <nav>
            <button id="navCheckIn" class="active">Student Check-In</button>
            <button id="navCheckOut">Staff Check-Out</button>
        </nav>
        <section id="checkInPage" class="page active">
            <h2>New Laundry Batch</h2>
            <form id="laundryForm">
                <div class="form-group">
                    <label for="studentName">Student Name</label>
                    <input type="text" id="studentName" required>
                </div>
                <div class="form-group">
                    <label for="laundryCard">Laundry Card Number</label>
                    <input type="text" id="laundryCard" required>
                </div>
                <!-- Updated Number of Cloth Items section -->
                <div class="form-group">
                    <label>Number of Cloth Items</label>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <div style="display: flex; align-items: center;">
                            <label style="width: 140px;" for="jeans">Jeans</label>
                            <input type="number" min="0" max="10" value="0" step="1" id="jeans" class="item-input">
                        </div>
                        <div style="display: flex; align-items: center;">
                            <label style="width: 140px;" for="pant">Pant</label>
                            <input type="number" min="0" max="10" value="0" step="1" id="pant" class="item-input">
                        </div>
                        <div style="display: flex; align-items: center;">
                            <label style="width: 140px;" for="pyjama">Pyjama</label>
                            <input type="number" min="0" max="10" value="0" step="1" id="pyjama" class="item-input">
                        </div>
                        <div style="display: flex; align-items: center;">
                            <label style="width: 140px;" for="shorts">Shorts</label>
                            <input type="number" min="0" max="10" value="0" step="1" id="shorts" class="item-input">
                        </div>
                        <div style="display: flex; align-items: center;">
                            <label style="width: 140px;" for="shirt">Shirt</label>
                            <input type="number" min="0" max="10" value="0" step="1" id="shirt" class="item-input">
                        </div>
                        <div style="display: flex; align-items: center;">
                            <label style="width: 140px;" for="tshirt">T-shirt</label>
                            <input type="number" min="0" max="10" value="0" step="1" id="tshirt" class="item-input">
                        </div>
                        <div style="display: flex; align-items: center;">
                            <label style="width: 140px;" for="kurta_salwar">Kurta/Salwar</label>
                            <input type="number" min="0" max="10" value="0" step="1" id="kurta_salwar" class="item-input">
                        </div>
                        <div style="display: flex; align-items: center;">
                            <label style="width: 140px;" for="skirt">Skirt</label>
                            <input type="number" min="0" max="10" value="0" step="1" id="skirt" class="item-input">
                        </div>
                        <div style="display: flex; align-items: center;">
                            <label style="width: 140px;" for="dupatta">Dupatta</label>
                            <input type="number" min="0" max="10" value="0" step="1" id="dupatta" class="item-input">
                        </div>
                        <div style="display: flex; align-items: center;">
                            <label style="width: 140px;" for="bed_sheet">Bed Sheet</label>
                            <input type="number" min="0" max="10" value="0" step="1" id="bed_sheet" class="item-input">
                        </div>
                        <div style="display: flex; align-items: center;">
                            <label style="width: 140px;" for="pillow_cover">Pillow Cover</label>
                            <input type="number" min="0" max="10" value="0" step="1" id="pillow_cover" class="item-input">
                        </div>
                        <div style="display: flex; align-items: center;">
                            <label style="width: 140px;" for="towel">Towel/H-towel</label>
                            <input type="number" min="0" max="10" value="0" step="1" id="towel" class="item-input">
                        </div>
                        <div style="display: flex; align-items: center;">
                            <label style="width: 140px;" for="turban">Turban</label>
                            <input type="number" min="0" max="10" value="0" step="1" id="turban" class="item-input">
                        </div>
                        <div style="display: flex; align-items: center;">
                            <label style="width: 140px;" for="upper_hood">Upper Hood</label>
                            <input type="number" min="0" max="10" value="0" step="1" id="upper_hood" class="item-input">
                        </div>
                    </div>
                    <div id="clothLimitWarning">Total items cannot exceed 10.</div>
                    <div class="form-group" style="margin-top:10px;">
                        <label for="itemCount">Total Cloth Items</label>
                        <input type="number" id="itemCount" readonly required>
                    </div>
                </div>
                <!-- End Updated Section -->
                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <input type="tel" id="phone" required>
                </div>
                <button type="submit" class="btn-submit">Generate Receipt</button>
            </form>
        </section>
        <section id="receiptPage" class="page">
            <h2>Student Receipt</h2>
            <p>Please take a screenshot of this QR code.</p>
            <div id="qrcode"></div>
            <h3>Order Details:</h3>
            <div id="receiptDetails"></div>
            <button id="createNewBtn" class="btn-submit" style="background-color: #6c757d; margin-top: 20px;">New Student</button>
        </section>
        <section id="checkOutPage" class="page">
            <h2>Scan for Collection</h2>
            <p>Hold the student's QR code up to the camera.</p>
            <div id="qr-reader"></div>
            <div id="scanResult"></div>
            <button id="collectButton">Mark as Collected</button>
        </section>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            let laundryDB = JSON.parse(localStorage.getItem('sustainawashDB')) || {};
            function saveDB() { localStorage.setItem('sustainawashDB', JSON.stringify(laundryDB)); }

            const navCheckIn = document.getElementById('navCheckIn');
            const navCheckOut = document.getElementById('navCheckOut');
            const checkInPage = document.getElementById('checkInPage');
            const checkOutPage = document.getElementById('checkOutPage');
            const receiptPage = document.getElementById('receiptPage');
            const laundryForm = document.getElementById('laundryForm');
            const studentName = document.getElementById('studentName');
            const laundryCard = document.getElementById('laundryCard');
            const itemCount = document.getElementById('itemCount');
            const phone = document.getElementById('phone');
            const qrcodeEl = document.getElementById('qrcode');
            const receiptDetails = document.getElementById('receiptDetails');
            const createNewBtn = document.getElementById('createNewBtn');
            const qrReaderEl = document.getElementById('qr-reader');
            const scanResult = document.getElementById('scanResult');
            const collectButton = document.getElementById('collectButton');
            let html5QrCodeScanner;

            const clothLimitWarning = document.getElementById('clothLimitWarning');

            const itemFields = [
                'jeans','pant','pyjama','shorts','shirt','tshirt','kurta_salwar','skirt',
                'dupatta','bed_sheet','pillow_cover','towel','turban','upper_hood'
            ];

            let lastValues = {};
            itemFields.forEach(id => { lastValues[id] = 0; });

            function updateTotalItems(changedId=null) {
                let total = 0;
                itemFields.forEach(id => {
                    total += parseInt(document.getElementById(id).value, 10) || 0;
                });
                if (total > 10 && changedId) {
                    // Disallow last change and show warning
                    document.getElementById(changedId).value = lastValues[changedId];
                    clothLimitWarning.style.display = "block";
                    // Recalculate after reverting
                    total = 0;
                    itemFields.forEach(id => {
                        total += parseInt(document.getElementById(id).value, 10) || 0;
                    });
                } else {
                    clothLimitWarning.style.display = "none";
                }
                itemCount.value = total;

                // store last valid value for each field
                itemFields.forEach(id => {
                    lastValues[id] = parseInt(document.getElementById(id).value, 10) || 0;
                });
            }

            itemFields.forEach(id => {
                document.getElementById(id).addEventListener('input', function() {
                    updateTotalItems(id);
                });
            });
            updateTotalItems();

            function showPage(pageId) {
                document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
                if (pageId !== 'checkOutPage' && html5QrCodeScanner) { stopScanner(); }
                document.getElementById(pageId).classList.add('active');
                if (pageId === 'checkInPage') { navCheckIn.classList.add('active');
                } else if (pageId === 'checkOutPage') { navCheckOut.classList.add('active'); startScanner(); }
            }
            navCheckIn.addEventListener('click', () => showPage('checkInPage'));
            navCheckOut.addEventListener('click', () => showPage('checkOutPage'));
            createNewBtn.addEventListener('click', () => showPage('checkInPage'));

            laundryForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (parseInt(itemCount.value, 10) > 10) {
                    clothLimitWarning.style.display = "block";
                    return;
                }
                const batchId = 'S-' + Date.now();
                const itemDetails = {};
                itemFields.forEach(id => { itemDetails[id] = parseInt(document.getElementById(id).value, 10) || 0; });
                const batchData = {
                    name: studentName.value,
                    card: laundryCard.value,
                    items: itemCount.value,
                    phone: phone.value,
                    itemDetails: itemDetails,
                    status: 'Pending'
                };
                laundryDB[batchId] = batchData;
                saveDB();
                qrcodeEl.innerHTML = '';
                new QRCode(qrcodeEl, {
                    text: batchId,
                    width: 250, height: 250, colorDark: "#000", colorLight: "#fff", correctLevel: QRCode.CorrectLevel.H
                });
                let itemListHTML = '';
                Object.entries(batchData.itemDetails).forEach(([key, val]) => {
                    if (val > 0) {
                        const label = key.replace(/_/g," ").replace(/\b\w/g, l => l.toUpperCase());
                        itemListHTML += `<li>${label}: ${val}</li>`;
                    }
                });
                receiptDetails.innerHTML = `
                    <p><strong>Student:</strong> ${batchData.name}</p>
                    <p><strong>Card No:</strong> ${batchData.card}</p>
                    <p><strong>Total Items:</strong> ${batchData.items}</p>
                    ${itemListHTML ? `<ul>${itemListHTML}</ul>` : ''}
                    <p><strong>Batch ID:</strong> ${batchId}</p>
                `;
                showPage('receiptPage');
                laundryForm.reset(); // Clear for next entry
                itemFields.forEach(id => { document.getElementById(id).value = 0; });
                updateTotalItems();
            });

            function startScanner() {
                if (html5QrCodeScanner && html5QrCodeScanner.isScanning) { return; }
                html5QrCodeScanner = new Html5Qrcode("qr-reader");
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                html5QrCodeScanner.start({ facingMode: "environment" }, config, onScanSuccess, onScanError);
            }
            function stopScanner() {
                if (html5QrCodeScanner && html5QrCodeScanner.isScanning) {
                    html5QrCodeScanner.stop()
                        .then(() => console.log("QR Scanner stopped."))
                        .catch(err => console.warn("Failed to stop QR scanner:", err));
                }
            }
            function onScanSuccess(decodedText, decodedResult) {
                stopScanner();
                scanResult.classList.remove('error', 'success');
                collectButton.style.display = 'none';
                const data = laundryDB[decodedText];
                if (data) {
                    if (data.status === 'Collected') {
                        scanResult.innerHTML = `<strong>Batch Already Collected!</strong><br>
                                                Student: ${data.name}<br>
                                                Card: ${data.card}`;
                        scanResult.classList.add('error');
                    } else {
                        let itemListHTML = '';
                        Object.entries(data.itemDetails).forEach(([key, val]) => {
                            if (val > 0) {
                                const label = key.replace(/_/g," ").replace(/\b\w/g, l => l.toUpperCase());
                                itemListHTML += `${label}: ${val}<br>`;
                            }
                        });
                        scanResult.innerHTML = `<strong>Match Found!</strong><br>
                                                <strong>Student:</strong> ${data.name}<br>
                                                <strong>Card No:</strong> ${data.card}<br>
                                                <strong>Items:</strong> ${data.items}<br>
                                                <strong>Phone:</strong> ${data.phone}<br>
                                                ${itemListHTML}`;
                        scanResult.classList.add('success');
                        collectButton.style.display = 'block';
                        collectButton.onclick = () => {
                            data.status = 'Collected';
                            laundryDB[decodedText] = data;
                            saveDB();
                            scanResult.innerHTML = `<strong>Batch for ${data.name} marked as collected!</strong>`;
                            scanResult.classList.add('success');
                            collectButton.style.display = 'none';
                        };
                    }
                } else {
                    scanResult.innerHTML = `<strong>Invalid QR Code!</strong><br>Batch ID not found in system.`;
                    scanResult.classList.add('error');
                }
            }
            function onScanError(errorMessage) { /* Do nothing for most errors. */ }
            showPage('checkInPage');
        });
    </script>
</body>
</html>
